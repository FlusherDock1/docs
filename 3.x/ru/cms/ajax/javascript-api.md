---
subtitle: Взаимодействуйте с обработчиками с помощью JavaScript.
---
# JavaScript API

API JavaScript более гибкий, чем API атрибутов данных. Метод `request` можно использовать с любым элементом внутри формы или с элементом формы. Когда метод используется с элементом внутри формы, он перенаправляется в форму.

Метод `request` имеет единственный обязательный аргумент — имя обработчика AJAX. Пример:

```html
<form onsubmit="$(this).request('onProcess'); return false;">
    ...
```

Вторым аргументом метода `request` является объект параметров. Вы можете использовать любые параметры и методы, совместимые с [jQuery AJAX функциями] (http://api.jquery.com/jQuery.ajax/). Следующие параметры только для фреймворка October CMS.

Параметр | Описание
------------- | -------------
**update** | объект, указывает список фрагментов которые надо обновить: `{'partial': '#select'}`. Если перед строкой селектора стоит символ `@`, содержимое, полученное с сервера, будет добавлено к элементу вместо замены существующего содержимого.
**confirm** | строка подтверждения. Если указано, перед отправкой запроса отображается подтверждение. Если пользователь нажимает кнопку «Отмена», запрос отменяется.
**data** | необязательный объект, определяющий данные для отправки на сервер вместе с данными формы: {var: 'value'}. Если для `files` установлено значение true, вы также можете включить файлы для загрузки в этот объект с помощью [объектов `Blob`](https://developer.mozilla.org/en-US/docs/Web/API/Blob). Чтобы указать имя файла любого объекта `Blob`, просто установите свойство `filename` в объекте `Blob`. (Например, `var blob = new Blob(variable); blob.filename = 'test.txt'; var data = {'uploaded_file': blob};`)
**redirect** | строка, указывающая URL-адрес для перенаправления браузера после успешного запроса.
**beforeUpdate** | колбэк, выполняемый перед обновлением элементов страницы. Функция получает 3 параметра: объект данных полученный от сервера, текстовую строку состояния и объект jqXHR. Переменная `this` внутри функции относится к содержимому запроса – объект, содержащий 2 свойства: `handler` и `options`, представляющие исходные параметры request().
**afterUpdate** | колбэк идентичный `beforeUpdate`, кроме того что он выполняется после обновления содержимого страницы.
**success** | колбэк функция, выполняемая в случае успешного запроса. Если указан этот параметр, он переопределяет стандартные методы фреймворка: элементы не обновляются, колбэки `beforeUpdate` и `afterUpdate` не запускаются, события `ajaxUpdate` и `ajaxUpdateComplete` не запускаются. Обработчик события получает 3 аргумента: объект данных полученный от сервера, текстовую строку состояния и объект jqXHR. Тем не менее, вы все равно можете вызвать стандартные функции фреймворка, вызвав `this.success(...)` внутри вашей функции.
**error** | колбэк, выполняемый в случае ошибки. По умолчанию отображается предупреждающее сообщение. Если этот параметр переопределен, предупреждающее сообщение не будет отображаться. Обработчик получает 3 параметра: объект jqXHR, текстовую строку состояния и объект ошибки — см. [функция jQuery AJAX](http://api.jquery.com/jQuery.ajax/).
**complete** | колбэк, вызываемый после `success` или `error`.
**form** | элемент формы, используемый для получения данных формы, отправленных с запросом, либо переданный как строка селектора, либо как элемент формы.
**flash** | когда true, указывает серверу очищать и отправлять любые флэш-сообщения с ответом. по умолчанию: false
**files** | когда true, запрос будет принимать загрузку файлов, для этого требуется поддержка интерфейса `FormData` браузером. по умолчанию: false
**browserValidate** | когда true, перед отправкой запроса будет выполняться валидация на стороне клиента в его браузере. Применяется только к запросам, инициированным в контексте элемента `<form>`.
**loading** | необязательная строка или объект, который будет отображаться при выполнении запроса. Строка должна быть селектором CSS для элемента, объект должен поддерживать функции `show()` и `hide()` для управления отображением. Вы можете передать глобальный объект `$.oc.stripeLoadIndicator` при использовании [дополнительных возможностях фреймворка](../ajax/extras.md).

Вы также можете переопределить часть логики запроса, передав новые функции в качестве параметров. Доступны следующие логические обработчики.

Обработчик | Описание
------------- | -------------
**handleConfirmMessage(message)** | вызывается при запросе подтверждения от пользователя.
**handleErrorMessage(message)** | вызывается, когда должно отображаться сообщение об ошибке.
**handleValidationMessage(message, fields)** | фокусирует первое недопустимое поле при использовании валидации.
**handleFlashMessage(message, type)** | вызывается, когда передается флэш-сообщение с использованием опции **flash** (см. выше).
**handleRedirectResponse(url)** | вызывается, когда браузер должен совершить редирект.

## Примеры использования

Запросить подтверждение перед отправкой запроса в хандлер `onDelete`.

```js
$('form').request('onDelete', {
    confirm: 'Вы уверены?',
    redirect: '/dashboard'
})
```

Запустить `onCalculate` обработчик и вставить содержимое фрагмента **calcresult** в элементы страницы с классом **result**.

```js
$('form').request('onCalculate', {
    update: {calcresult: '.result'}
})
```

Запустить `onCalculate` обработчик с дополнительными данными.

```js
$('form').request('onCalculate', {data: {value: 55}})
```

Запустить `onCalculate` обработчик и запустить кастомный код перед обновление содержимого страницы.

```js
$('form').request('onCalculate', {
    update: {calcresult: '.result'},
    beforeUpdate: function() { /* сделай что-нибудь */ }
})
```

Запустить `onCalculate` обработчик и если он успешно отработал, выполнить кастомный код и стандартную функцию `success`.

```js
$('form').request('onCalculate', {success: function(data) {
    //... do something ...
    this.success(data);
}})
```

Отправить запрос без элемента Form.

```js
$.request('onCalculate', {
    success: function() {
        console.log('Finished!');
    }
})
```

Запустить `onCalculate` обработчик и если он успешно отработал, выполнить стандартную функцию `success` и после кастомный код.

```js
$('form').request('onCalculate', { success: function(data) {
    this.success(data).done(function() {
        // ... Сделай что-нибудь после выполнения стандартного success()
    });
}})
```

## Глобальные AJAX события 

AJAX фреймворк вызывает несколько событий для обновленных элементов, инициирующего элемента, формы и объекта окна. События вызываются независимо от того, какой API использовался — API атрибутов данных или API JavaScript.

Событие | Описание
------------- | -------------
**ajaxBeforeSend** | срабатывает на объекте `window` перед отправкой запроса.
**ajaxBeforeUpdate** | срабатывает в объекте формы сразу после завершения запроса, но до обновления страницы. Обработчик получает 5 параметров: объект события, объект контекста, объект данных, полученных от сервера, текстовую строку статуса и объект jqXHR.
**ajaxUpdate** | triggered on a page element after it has been updated with the framework. The handler gets 5 parameters: the event object, the context object, the data object received from the server, the status text string, and the jqXHR object.
**ajaxUpdateComplete** | срабатывает на объекте `window` после того, как все элементы обновлены фреймворком. Обработчик получает 5 параметров: объект события, объект контекста, объект данных, полученных от сервера, текстовую строку статуса и объект jqXHR.
**ajaxSuccess** | срабатывает в объекте формы после успешного выполнения запроса. Обработчик получает 5 параметров: объект события, объект контекста, объект данных, полученных от сервера, текстовую строку статуса и объект jqXHR.
**ajaxError** | срабатывает в объекте формы, если запрос обнаруживает ошибку. Обработчик получает 5 параметров: объект события, объект контекста, сообщение об ошибке, текстовую строку состояния и объект jqXHR.
**ajaxErrorMessage** | срабатывает для объекта `window`, если запрос обнаруживает ошибку. Обработчик получает 2 параметра: объект события и сообщение об ошибке, возвращаемое сервером.
**ajaxConfirmMessage** | срабатывает для объекта `window`, когда указана опция `confirm`. Обработчик получает 2 параметра: объект события и текстовое сообщение, назначенное обработчику как часть опции `confirm`. Это полезно для реализации пользовательской логики/интерфейса подтверждения вместо стандартного окна подтверждения javascript.

Эти события запускаются на инициирующем элементе:

Событие | Описание
------------- | -------------
**ajaxSetup** |запускается до формирования запроса, что позволяет изменять параметры с помощью объекта `context.options`.
**ajaxPromise** | запускается непосредственно перед отправкой запроса AJAX.
**ajaxFail** | запускается если запрос AJAX терпит неудачу.
**ajaxDone** | запускается если запрос AJAX был успешным.
**ajaxAlways** | срабатывает независимо от того, был ли запрос AJAX неудачным или успешным.

## Примеры использования

Выполняет код JavaScript, когда для элемента запускается событие `ajaxUpdate`.

```js
$('.calcresult').on('ajaxUpdate', function() {
    console.log('Обновлено!');
})
```

Выполнение одного запроса, который отобразит кастомное флэш-сообщение.

```js
$.request('onDoSomething', {
    flash: 1,
    handleFlashMessage: function(message, type) {
        $.oc.flashMsg({ text: message, class: type });
    }
});
```

Применяет конфигурации ко всем AJAX запросам глобально.

```js
$(document).on('ajaxSetup', function(event, context) {
    // Включить поддержку флэш-сообщений для всех AJAX запросов
    context.options.flash = true;

    // Включить StripeLoadIndicator для всех AJAX запросов 
    context.options.loading = $.oc.stripeLoadIndicator;

    // Обрабатывайте сообщения об ошибках, вызывая flashMsg типа error
    context.options.handleErrorMessage = function(message) {
        $.oc.flashMsg({ text: message, class: 'error' });
    }

    // Обрабатывайте сообщения об ошибках, вызывая flashMsg типа type
    context.options.handleFlashMessage = function(message, type) {
        $.oc.flashMsg({ text: message, class: type });
    }
});
```
