---
subtitle: Создайте свой API и динамически обновляйте страницу.
---
# Обработчики событий

## AJAX обработчики

Обработчики событий AJAX — это функции PHP, которые можно определить в разделе PHP страницы или макета или [внутри компонентов](../themes/components.md). Имена обработчиков должны использовать шаблон `onSomething`, например, `onName`. Все обработчики поддерживают [обновления фрагментов](./update-partials.md) как часть запроса AJAX.

```php
function onSubmitContactForm()
{
    // ...
}
```

::: tip
Если два обработчика с одинаковыми именами определены на странице и макете вместе, обработчик страницы будет иметь приоритет. Обработчики, определенные в компонентах, имеют самый низкий приоритет.
:::

### Вызов обработчика

Каждый AJAX запрос должен указывать имя обработчика, используя либо [API атрибутов данных](../ajax/attributes-api.md), либо [API JavaScript](../ajax/javascript-api.md). Когда запрос сделан, сервер будет искать все зарегистрированные обработчики и найдет первый найденный.

```html
<!-- API атрибутов -->
<button data-request="onSubmitContactForm">Вперед</button>

<!-- JavaScript API -->
<script> $.request('onSubmitContactForm') </script>
```

### Стандартный обработчик

Иногда вам может потребоваться сделать AJAX запрос с единственной целью обновления содержимого страницы, не требуя выполнения какого-либо кода. Для этой цели вы можете использовать обработчик `onAjax`. Этот обработчик доступен везде без необходимости написания кода.

```html
<button data-request="onAjax">Ничего не делать</button>
```

### Обработчики компонентов

Если два компонента регистрируют одно и то же имя обработчика, рекомендуется добавлять к обработчику префикс [короткое имя или псевдоним компонента](../../cms/themes/components.md). Если компонент использует псевдоним **mycomponent**, обработчик может быть указан с помощью `mycomponent::onName`.

```html
<button data-request="mycomponent::onSubmitContactForm">Вперед</button>
```

Вы можете использовать переменную `__SELF__` вместо жестко заданного псевдонима на случай, если пользователь изменит псевдоним компонента, используемый на странице. См. [разработка компонентов](../../extend/cms-components.md), чтобы узнать больше.

```html
<form
    data-request="{{ __SELF__ }}::onCalculate"
    data-request-update="'{{ __SELF__ }}::calcresult': '#result'"
>
```

## Редиректы через AJAX обработчики

Если вам нужно совершить редирект, верните объект ответа `Redirect` из обработчика AJAX. Платформа перенаправит браузер, как только ответ будет возвращен с сервера. Пример обработчика AJAX с перенаправлением.

```php
function onRedirectMe()
{
    return Redirect::to('http://google.com');
}
```

## Возврат данных из обработчиков AJAX

Ответ от AJAX обработчика может служить в качестве API, возвращая структурированные данные. Если обработчик возвращает массив, вы можете получить доступ к его элементам в событии `success`. Пример обработчика AJAX, который возвращает объект данных.

```php
function onFetchDataFromServer()
{
    // Какой-нибудь код 

    return [
        'totalUsers' => 1000,
        'totalProjects' => 937
    ];
}
```

Данные можно получить с помощью атрибутов.

```html
<form data-request="onHandleForm" data-request-success="console.log(data)">
```

Тоже самое можно сделать и в JavaScript

```html
<form
    onsubmit="$(this).request('onHandleForm', {
        success: function(data) {
            console.log(data);
        }
    }); return false;"
>
```

## Генерирование AJAX исключения

Вы можете сгенерировать [AJAX исключение](../../extend/system/exceptions.md), используя класс `AjaxException`, чтобы обработать ответ как ошибку, сохраняя при этом возможность отправлять содержимое ответа как обычно. Просто передайте содержимое ответа в качестве первого аргумента исключения.

```php
throw new AjaxException([
    'error' => 'Not enough questions',
    'questionsNeeded' => 2
]);
```

::: tip
При генерации этого типа исключения [фрагменты будут обновлены](./update-partials.md) как обычно.
:::

## Исполнение кода перед AJAX обработчиками

Иногда необходимо, чтобы код выполнялся до AJAX обработчика. Определение функции `onInit` как части [жизненного цикла макета](../../cms/themes/layouts.md) позволяет запускать код перед каждым обработчиком AJAX.

```php
function onInit()
{
    // Из PHP секции страницы или макета
}
```

Вы можете определить метод `init` внутри [CMS компонентов](../../extend/cms-components.md).

```php
function init()
{
    // Из компонента или виджета
}
```
